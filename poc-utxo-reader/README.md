# Run the PoC for UTxO reader from immutable files

## Installation
- Install a correctly configured Rust toolchain (latest stable version). You can follow the instructions provided [here](https://www.rust-lang.org/learn/get-started).

- A recent version of [`jq`](https://stedolan.github.io/jq/) (1.6+).

## Build the binary

Switch to the PoC folder:
```bash
$ cd poc-utxo-reader
```

Build the binary with the command:
```bash
$ cargo build --release
$ cp ../target/release/poc-utxo-reader .
```

Verify the binary:
```bash
$ ./poc-utxo-reader --help
This program imports transactions from immutable files and queries the associated UTxOs.

Usage: poc-utxo-reader [OPTIONS] --command <COMMAND>

Options:
      --command <COMMAND>
          Command to run
      --data-directory <DATA_DIRECTORY>
          Data directory where immutable files are located
      --db-path <DB_PATH>
          Database location [default: :memory:]
      --min-immutable-file-number-import <MIN_IMMUTABLE_FILE_NUMBER_IMPORT>
          Min immutable file number imported
      --max-immutable-file-number-import <MAX_IMMUTABLE_FILE_NUMBER_IMPORT>
          Max immutable file number imported
      --with-parallelization
          With parallelization
      --address <ADDRESS>
          Address to lookup records from
      --immutable-file-number-query <IMMUTABLE_FILE_NUMBER_QUERY>
          Immutable file number queried
  -h, --help
          Print help
```

## Import transactions from immutable files

Import all the immutable files in a folder to a custom SQLite store:
```bash
$ ./poc-utxo-reader --command import --db-path ./utxo-preprod.sqlite3 --data-directory ./db/preprod/immutable
```

Import the first 100 immutable files in a folder to a custom SQLite store:
```bash
$ ./poc-utxo-reader --command import --db-path ./utxo-preprod.sqlite3 --data-directory ./db/preprod/immutable --max-immutable-file-number-import 100
```

Import the range [50, 100] of immutable files in a folder to a custom SQLite store:
```bash
$ ./poc-utxo-reader --command import --db-path ./utxo-preprod.sqlite3 --data-directory ./db/preprod/immutable --min-immutable-file-number-import 50 --max-immutable-file-number-import 100
```

Import all the immutable files in a folder to a custom SQLite store with immutable files parallelized scanning (faster, uses more memory; by default import is sequential):
```bash
$ ./poc-utxo-reader --command import --db-path ./utxo-preprod.sqlite3 --data-directory ./db/preprod/immutable --with-parallelization true
```

## Query UTxO from imported immutable files

Query the latest UTxOs for an address:
```bash
$ ./poc-utxo-reader --command query-utxo --db-path ./utxo-preprod.sqlite3 --address addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx | jq .
[
  {
    "address": "addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx",
    "hash": "b1a7cc8964a6233340e8fb5d4aeb0544f327b15380c3faf2cfa41a166567728a",
    "index": 0,
    "quantity": 2000000,
    "data_hash": "868e5606149c66c3cb8558a098113dffec0758cb26bbe3709f55ec76d4274271"
  },
  {
    "address": "addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx",
    "hash": "b1a7cc8964a6233340e8fb5d4aeb0544f327b15380c3faf2cfa41a166567728a",
    "index": 1,
    "quantity": 9997822971,
    "data_hash": ""
  }
]
```

Query the UTxOs for an address up to a specific immutable file:
```bash
$ ./poc-utxo-reader --command query-utxo --db-path ./utxo-preprod.sqlite3 --address addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx --immutable-file-number-query 250 | jq .
```

Query the UTxO set for all addresses:
```bash
$ ./poc-utxo-reader --command query-utxo --db-path ./utxo-preprod.sqlite3 | jq .
```

Query the UTxO set for all addresses up to a specific immutable file:
```bash
$ ./poc-utxo-reader --command query-utxo --db-path ./utxo-preprod.sqlite3 --immutable-file-number-query 250 | jq .
```

## Certify UTxO from imported immutable files

Certify the latest UTxOs for an address:
```bash
$ ./poc-utxo-reader --command certify-utxo --db-path ./utxo-preprod.sqlite3 --address addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx
>> Retrieving all the UTxOs from the database...
>> Retrieved all 185550 UTxOs
 
>> Creating the Merkle tree...
>> Created a Merkle tree with 185550 leaves and root 27118b2138a80427aa799fef8f0292f3f96aba92b6dd9bd1a0b0f9108d762d70
 
>> Verifying UTxOs of address addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx...
>>>> Create Merkle proof for UTxO UTxO {
    address: "addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx",
    hash: "b1a7cc8964a6233340e8fb5d4aeb0544f327b15380c3faf2cfa41a166567728a",
    index: 0,
    quantity: 2000000,
    data_hash: Some(
        "868e5606149c66c3cb8558a098113dffec0758cb26bbe3709f55ec76d4274271",
    ),
}
>>>>>> Congrats, the Merkle roof is valid!
>>>> Create Merkle proof for UTxO UTxO {
    address: "addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx",
    hash: "b1a7cc8964a6233340e8fb5d4aeb0544f327b15380c3faf2cfa41a166567728a",
    index: 1,
    quantity: 9997822971,
    data_hash: Some(
        "",
    ),
}
>>>>>> Congrats, the Merkle roof is valid!
>> Congrats, all UTxOs of address addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx are valid!
```

## Query transactions from imported immutable files

Query the latest transactions for an address:
```bash
$ ./poc-utxo-reader --command query-tx --db-path ./utxo-preprod.sqlite3 --address addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx | jq .
[
  "b98db611cd8fe665b9ac17634254822cbb47af6c7f6561e77fe4df8cbe051ea8",
  "b1a7cc8964a6233340e8fb5d4aeb0544f327b15380c3faf2cfa41a166567728a"
]
```

Query the transactions for an address up to a specific immutable file:
```bash
$ ./poc-utxo-reader --command query-tx --db-path ./utxo-preprod.sqlite3 --address addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx --immutable-file-number-query 250 | jq .
```

Query the transactions set for all addresses:
```bash
$ ./poc-utxo-reader --command query-tx --db-path ./utxo-preprod.sqlite3 | jq .
```

Query all the transactions up to a specific immutable file:
```bash
$ ./poc-utxo-reader --command query-tx --db-path ./utxo-preprod.sqlite3 --immutable-file-number-query 250 | jq .
```

## Certify transactions from imported immutable files

Certify the latest transactions for an address:
```bash
$ ./poc-utxo-reader --command certify-tx --db-path ./utxo-preprod.sqlite3 --address addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx
>> Retrieving all the transactions from the database...
>> Retrieved all 1668054 transactions
 
>> Creating the Merkle tree...
>> Created a Merkle tree with 1668054 leaves and root 802d420d0c2a1e0d9dcde004abf175e239a377f2fab15e789ad63ac34a0a1696
 
>> Verifying transactions of address addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx...
>>>> Create Merkle proof for transactions [
    "b98db611cd8fe665b9ac17634254822cbb47af6c7f6561e77fe4df8cbe051ea8",
    "b1a7cc8964a6233340e8fb5d4aeb0544f327b15380c3faf2cfa41a166567728a",
]
>>>>>> Serialized Merkle proof is:
7b22696e6e65725f726f6f74223a7b2268617368223a5b3132382c34352c36362c31332c31322c34322c33302c31332c3135372c3230352c3232342c342c3137312c3234312c3131372c3232362c35372c3136332c3131392c3234322c3235302c3137372c39342c3132302c3135342c3231342c35382c3139352c37342c31302c32322c3135305d7d2c22696e6e65725f6c6561766573223a5b5b3839303138362c7b2268617368223a5b39382c35372c35362c3130302c39382c35342c34392c34392c39392c3130302c35362c3130322c3130312c35342c35342c35332c39382c35372c39372c39392c34392c35352c35342c35312c35322c35302c35332c35322c35362c35302c35302c39392c39382c39382c35322c35352c39372c3130322c35342c39392c35352c3130322c35342c35332c35342c34392c3130312c35352c35352c3130322c3130312c35322c3130302c3130322c35362c39392c39382c3130312c34382c35332c34392c3130312c39372c35365d7d5d2c5b313030353834372c7b2268617368223a5b39382c34392c39372c35352c39392c39392c35362c35372c35342c35322c39372c35342c35302c35312c35312c35312c35322c34382c3130312c35362c3130322c39382c35332c3130302c35322c39372c3130312c39382c34382c35332c35322c35322c3130322c35312c35302c35352c39382c34392c35332c35312c35362c34382c39392c35312c3130322c39372c3130322c35302c39392c3130322c39372c35322c34392c39372c34392c35342c35342c35332c35342c35352c35352c35302c35362c39375d7d5d5d2c22696e6e65725f70726f6f665f73697a65223a333333363039352c22696e6e65725f70726f6f665f6974656d73223a5b7b2268617368223a5b39382c34392c34392c3130322c35362c35322c34392c3130302c39382c34382c35352c39372c39382c35302c3130312c3130322c39392c39392c3130322c35372c35362c39372c39382c39392c39382c35372c35322c35332c35372c35372c3130312c35342c34382c3130302c3130302c35302c34382c35322c35362c35372c34392c34382c35352c35302c39382c3130302c3130322c34382c35302c3130312c35332c34382c35352c3130312c3130322c3130322c35362c35352c35342c35332c35352c35342c3130322c3130315d7d2c7b2268617368223a5b35302c35332c35342c35302c35332c34382c35312c3130312c35342c35362c35312c39392c35342c3130312c35322c39372c35332c3130322c3130312c39382c34382c35362c35332c35342c3130302c39372c34392c35372c34382c3130322c35362c35302c3130322c34392c34392c35322c3130302c39372c34392c35342c35372c3130302c35372c35312c34392c34392c39372c35312c39392c3130312c39372c3130322c3130302c3130302c35312c34392c39382c35312c39382c34382c39392c3130302c34382c3130325d7d2c7b2268617368223a5b3135302c3233302c33342c32382c302c31362c39342c3234382c3230342c3135382c3230362c3134362c322c39312c3230352c3139342c39392c39322c3231302c33352c3132322c3230382c3132312c3130362c3139302c34322c3137342c3139382c38372c3233392c3138392c3233375d7d2c7b2268617368223a5b3130372c3135322c3231392c34312c3130342c34342c3231302c3138352c37312c3136352c3231322c3230302c3235302c33352c39392c3132362c33322c3233302c37322c3132382c3132302c3134372c3136352c3230322c3130302c3135392c3133352c34382c33322c38352c31322c3234325d7d2c7b2268617368223a5b3230352c3138392c39332c3134382c3136332c3132382c3133362c3131382c3233302c3135382c3134322c36362c362c31352c3132322c31312c31322c39392c3234392c33322c3135392c3233352c3138322c3136372c3233312c3137302c3139332c37372c33322c3139352c3139392c3233315d7d2c7b2268617368223a5b37372c3131332c3133302c3139332c3230322c3131332c3133312c3138382c3232372c32362c3138312c3134372c3136342c3232372c32302c38392c3233332c34302c3131372c3234362c3234332c3132342c3132352c3139302c3130342c3138302c35372c38322c38322c3134362c32382c37355d7d2c7b2268617368223a5b3231392c3137392c34342c3135382c37362c3135312c3135362c3135372c31342c39382c3133392c3233362c32302c3230322c32332c3133362c32382c3233332c37352c3234382c31352c3135352c3133372c37362c39312c3133332c3132332c3132372c34392c3133362c36322c3233305d7d2c7b2268617368223a5b3135372c3137392c32332c39312c3133332c3231322c37332c33382c3230312c32332c3130322c3230322c3130372c39342c3136312c3138392c3232342c3234392c31372c31322c37332c3231352c3230372c33312c32382c3132312c31302c33302c3134322c35362c3135332c31315d7d2c7b2268617368223a5b3137342c3135342c33382c3233322c39332c3130342c3136382c3138302c3135322c34302c36392c3139302c3230322c3233372c3232382c3232392c35392c3137392c31322c34362c35302c3233312c3233302c3138352c3139392c3134372c31382c38342c3135312c3133312c38382c38375d7d2c7b2268617368223a5b3131382c3135392c3234382c3134372c35342c3134342c3134332c3233372c36332c3139372c3138392c3230312c3134342c37332c3232342c3230332c39392c31352c37382c3132362c3136352c3136372c37322c3134362c3231312c38392c3130342c33362c3138372c39382c38322c34345d7d2c7b2268617368223a5b3138352c3233382c3232352c39302c3137382c3134362c3131382c3231332c3136372c38302c3138302c3132332c3137322c35362c3233342c3138372c33382c3232382c3130352c35302c35342c3231382c37372c3138392c33362c34302c38352c3135322c3233392c3231332c3231372c35345d7d2c7b2268617368223a5b3234382c37332c3139302c3130352c31322c3231332c3235322c35302c37312c3133342c3131352c32322c3131382c3230342c36342c32352c32392c31302c3139332c31322c3233362c3135302c37302c3230332c31352c3135362c34392c3130322c37352c3133342c3230392c34345d7d2c7b2268617368223a5b38372c3130332c3233352c37312c3231372c3136362c37322c3135372c3139312c3234312c3139332c31372c3131302c3133312c3132322c3139382c3136352c3131332c3132352c3138382c342c38332c3133302c35352c3136372c3135302c39382c3135372c37312c31342c31352c3134345d7d2c7b2268617368223a5b3135302c3130342c3231302c3134322c3135332c3131302c3136322c38382c3136322c3139372c3233362c37372c3133382c36322c3234362c37362c3133322c3136342c3138392c33302c3133332c3232382c3135352c34332c36332c3233302c3131342c31312c3230342c34382c382c35345d7d2c7b2268617368223a5b3232312c3139312c3139332c3234332c3232322c392c3136342c38382c3136382c3131362c31312c3234372c3233392c33362c3231312c3132382c3234302c31362c3131352c3131302c3131322c31372c33362c37392c3231342c32392c362c37352c38352c3133322c3134392c3234365d7d2c7b2268617368223a5b3131312c3230302c3130362c32352c38372c3235312c3134342c3135322c3230372c34312c3132352c31322c3233382c35342c33352c3134352c3130312c3234352c35362c33382c3132312c35302c3138332c3131372c3130322c3139322c3234392c37362c35352c3131302c3132332c3232305d7d2c7b2268617368223a5b372c39372c35332c3231382c3232352c39372c3131332c3131392c3136342c32312c39382c342c3232312c3134392c38322c3133382c3133312c3235322c3136322c3135362c3134362c3131342c3137312c3134302c36322c3234372c362c3233362c3134392c3134332c3139302c3230395d7d2c7b2268617368223a5b36332c38372c3231372c34312c3135392c3135362c38322c3230382c32322c32392c3233332c33322c3230342c39332c38322c3231332c3233342c3231372c3135312c37372c3138342c36352c3135332c3133372c3136362c3139382c3139332c34332c3230342c3135372c3231352c3232335d7d2c7b2268617368223a5b33372c33322c3231312c3231332c3233392c3133312c3138372c3131302c3234392c3132362c3134302c3135352c34312c3135342c3139312c3234372c31392c37302c38372c3137382c3139322c33302c3230312c3134312c3138332c34382c3134352c35392c33312c3136352c38342c39315d7d2c7b2268617368223a5b34342c3137312c3132332c36352c33382c3138382c38302c3232342c3231322c32302c36342c37322c39302c33312c3130392c3134342c3130312c3231362c3132302c39362c36392c33342c38352c3136342c3233382c3137382c33362c3130382c392c3136322c3233302c3133385d7d2c7b2268617368223a5b3137302c39342c36342c39392c3136312c31312c3130322c3139362c3231332c3133372c34352c3131382c33332c3135302c3231352c37362c3235322c3130332c32332c34332c3137342c3231322c36342c31392c3131392c3139382c39352c34302c3231322c35322c3133372c3234395d7d2c7b2268617368223a5b33352c3230322c3132302c3137342c3136342c3137302c3133332c3139302c3132362c3131342c38382c38392c3138352c3137332c3230372c3131372c32352c3231312c3131382c39392c33312c32312c3230312c33352c3235302c33332c3134392c37302c31352c3133392c3230312c3137385d7d2c7b2268617368223a5b34392c3136382c3137342c35362c3132362c3130302c33362c3232322c3134392c3230362c3231382c39302c32372c3139342c36362c3232302c3235332c36372c3135312c3131372c3137382c3134382c32382c3138322c3230342c3230342c3130342c37392c33332c37382c3235312c3131335d7d2c7b2268617368223a5b3231342c37362c3134352c38302c39322c36372c36352c36392c33342c3232342c3230352c3233312c38312c34372c3233322c3233312c3234312c36382c3135362c3136392c33392c342c36352c3232332c32352c3130322c3235312c34312c3131382c39322c3232372c32365d7d2c7b2268617368223a5b36392c35322c3133342c36362c3232372c37312c3235352c3139312c3233342c37302c35312c3231302c3133312c3234332c39342c3134362c31312c3230392c3235352c33392c32352c3234332c3233342c3234322c3133382c3230312c3135372c33302c31392c36332c3131352c3234385d7d2c7b2268617368223a5b3232332c3131322c33372c32332c3138302c3131382c37352c3230362c3134312c3134382c3230392c3137392c3233372c33312c3230312c3136312c38392c3230312c3231342c3234312c3131312c3136342c34302c39342c3136352c3230352c3136312c3234352c31302c3133322c3231322c3132335d7d2c7b2268617368223a5b3138362c34392c3231352c3138352c3139302c33342c36312c3130312c3230322c3138372c3234382c3234322c34372c3230392c3232322c39302c35362c3137312c36372c36322c3130332c3132342c36322c36392c3134382c3235332c35352c3231332c3231362c39362c32302c35355d7d2c7b2268617368223a5b36312c3136312c3235342c31362c39342c3232382c3234362c3136382c31362c39342c3230352c34382c31392c34352c3231332c38362c3131352c36382c3136332c37372c3132392c3134302c3235322c3139342c3235312c3135372c3133372c342c31352c3232392c36372c3136395d7d2c7b2268617368223a5b31312c3230322c3131382c34342c3230312c39332c33372c39382c3235352c3137372c3131302c36342c35332c35322c33362c3137382c3132392c33342c3133372c3230382c3137392c39322c3134362c37332c3139362c3136352c36332c3136362c3134342c33372c3230362c3234365d7d2c7b2268617368223a5b3234332c34352c382c3134382c3233372c32312c3233332c31362c36362c392c3137392c3132302c33352c31372c3235302c3137302c3231362c3232362c3232352c3132352c39362c36392c34352c3135312c3130372c3136342c3130372c31322c3134302c33352c3234382c3230335d7d2c7b2268617368223a5b3130392c31372c3130392c3132322c34372c3230392c3232362c3233342c31302c3231392c3136342c3130322c3232362c38312c3139332c35382c31302c3138352c32342c3130342c3131312c39382c362c3133342c3231322c3139302c34382c3139332c3234312c36342c3234392c3131365d7d2c7b2268617368223a5b35342c3234372c3230322c3235312c3132382c3133352c3130302c38372c3232322c3130342c3135302c3132322c33312c3234302c3139372c3234322c32342c3234382c3234322c36342c31382c3233362c3133312c3231382c3233312c3130382c3134392c382c3138342c3139362c3235312c355d7d2c7b2268617368223a5b3139372c3131352c34352c3130312c3234362c33302c3232342c3135332c3136382c382c3230372c3138342c3232312c372c39322c3135302c3235312c3136332c3232392c38362c3234362c33312c3137342c35362c38332c3231382c3138372c3139302c3230382c3138372c34382c39305d7d2c7b2268617368223a5b3138392c3136362c3133302c34382c3134322c34332c3231362c3132332c3139332c32362c3232302c38302c3137372c3138322c34372c3230312c36372c3135312c3135342c32392c37392c39322c3136332c3136302c32302c3233342c3135312c3131372c38362c3235302c3134322c36375d7d2c7b2268617368223a5b3131382c35392c3136312c35362c362c3130352c3133302c3230302c392c3234372c3135332c3130312c3234382c3139392c31372c33342c3232322c3137302c3133342c3133372c3135352c32312c332c35332c34302c3234322c37302c3233302c3232382c3235352c3134322c39325d7d2c7b2268617368223a5b3132392c362c3133302c3230372c31322c34302c3139322c35302c3232372c39312c3132332c3136332c3138342c3138362c3233382c3139332c3135372c32302c34342c3130302c3130312c3234392c352c392c3136342c3133342c32392c3135372c3134392c33302c34312c33375d7d5d7d
>>>>>> Congrats, the Merkle proof is valid!
>> Congrats, all transactions of address addr_test1qpkyv2ws0deszm67t840sdnruqgr492n80g3y96xw3p2ksk6suj5musy6w8lsg3yjd09cnpgctc2qh386rtxphxt248qr0npnx are valid!
```

